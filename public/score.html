<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Score Page</title>

  <!-- Latest compiled and minified CSS & JS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="css/styleamy.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

</head>

<body>

  <div class="container">

    <div class="row">
      <h1 class="text-center">
        <span class="fa fa-fire"></span> Hyperword</h1>
      <hr>
      <h2 class="text-center">post a score</h2>
      <br>

      <div class="text-center">
        <a href="/leaderboard">
          <button class="btn btn-lg btn-info">
            <span class="fa fa-list-alt"></span> View High Scores</button>
        </a>
        <a href="/">
          <button class="btn btn-lg btn-default">
            <span class="fa fa-home"></span>
          </button>
        </a>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">Score</h4>
          </div>
          <div class="panel-body">

              <p class="timer-container"></p>
              <p id="score"></p>
              <p id="POS"></p>
              <p id="answerSpace"></p>

            <div id="keyboard">
              <div class="row">
                  <div class="col-md-10 btn-group" id="row1">
                      <button type="button" class="btn btn-link" value="Q">Q<sub> 10</sub></button>
                      <button type="button" class="btn btn-link" value="W">W<sub> 4</sub></button>
                      <button type="button" class="btn btn-link" value="E">E<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="R">R<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="T">T<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="Y">Y<sub> 4</sub></button>
                      <button type="button" class="btn btn-link" value="U">U<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="I">I<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="O">O<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="P">P<sub> 3</sub></button>
                  </div>
              </div>    
              <div class="row">
                  <div class="col-md-10 btn-group" id="row2">
                      <button type="button" class="btn btn-link" value="A">A<sub> 1</sub></button> 
                      <button type="button" class="btn btn-link" value="S">S<sub> 1</sub></button> 
                      <button type="button" class="btn btn-link" value="D">D<sub> 2</sub></button> 
                      <button type="button" class="btn btn-link" value="F">F<sub> 4</sub></button> 
                      <button type="button" class="btn btn-link" value="G">G<sub> 2</sub></button> 
                      <button type="button" class="btn btn-link" value="H">H<sub> 4</sub></button> 
                      <button type="button" class="btn btn-link" value="J">J<sub> 8</sub></button> 
                      <button type="button" class="btn btn-link" value="K">K<sub> 5</sub></button>
                      <button type="button" class="btn btn-link" value="L">L<sub> 1</sub></button>   
                  </div>
              </div>
              <div class="row">
                  <div class="col-md-10 btn-group" id="row3">
                      <button type="button" class="btn btn-link" value="Z">Z<sub> 10</sub></button>
                      <button type="button" class="btn btn-link" value="X">X<sub> 8</sub></button>
                      <button type="button" class="btn btn-link" value="C">C<sub> 3</sub></button>       
                      <button type="button" class="btn btn-link" value="V">V<sub> 4</sub></button>
                      <button type="button" class="btn btn-link" value="B">B<sub> 3</sub></button>
                      <button type="button" class="btn btn-link" value="N">N<sub> 1</sub></button>
                      <button type="button" class="btn btn-link" value="M">M<sub> 3</sub></button>
                  </div>
              </div>    
              <div class="row">
                  <div class="col-md-10 btn-group"  id="row4">
                      <button type="button" class="btn btn-primary">Backspace</button>
                      <button type="button" class="btn btn-primary">Clear</button>
                      <button type="button" class="btn btn-primary">Submit</button>
                  </div>
              </div>    
          </div>
            <form role="form">

              <div class="form-group">
                <label for="reserve-name">UserName</label>
                <input type="text" class="form-control" id="reserve-name">
              </div>

              <div class="form-group">
                <label for="reserve-phone">Round Completed</label>
                <input type="text" class="form-control" id="reserve-phone">
              </div>

              <div class="form-group">
                <label for="reserve-unique-id">Score</label>
                <input type="text" class="form-control" id="reserve-unique-id">
              </div>

              <button type="submit" class="btn btn-secondary submit" id="submit-main">Submit</button>

              <button type="submit" class="btn btn-success submit" id="submit-noun">Get noun</button>
              <button type="submit" class="btn btn-danger submit" id="submit-verb">Get verb</button>
              <button type="submit" class="btn btn-warning submit" id="submit-adj">Get adjective</button>
              <button type="submit" class="btn btn-info submit" id="submit-adv">Get adverb</button>
            </form>

          </div>
        </div>

      </div>
    </div>
    <div class="row" id="definition-div"></div>

    <footer class="footer">
      <div class="container">
        <p>
          <a href="/api/scores">API Scores Link</a> |
          <a href="/api/waitlist">API Wait List</a> |
          <a href="https://github.com/mattieice7486/HyperWord">GitHub Repo</a>
        </p>
        <p>
          <a href="/api/all">API Dictionary All</a> |
          <a href="/api/nouns">API Noun List</a> |
          <a href="/api/verbs">API Verb List</a> |
          <a href="/api/adjectives">API Adj List</a> |
          <a href="/api/adverbs">API Adv List</a> 
        </p>
      </div>
    </footer>

  </div>

</body>

</html>

<script type="text/javascript">


// NEXT STEPS:
    //FIGURE OUT HOW TO QUERY DICTIONARY DB AND PUSH TO LEADERBOARD FROM HERE -- need to trigger win
    //NEED TO WORK ON GETTING STARTGAME TO RETURN WIN OR LOSS - good progress
    //INSERT AMY'S KEYBOARD AND ADD ID AND VALUES - will do later

    //document.ready stuff different from startGame() function? should startGame() not be included in on load page functions? should on load just have each individual function, not contained in startGame()?



var targetScore = Math.floor(Math.random() * (30 - 7)) + 7; //generate random score -- right range??
//function to instantiate new targetScore??????????????????????

var partsOfSpeechArray = ["noun", "adjective", "verb", "adverb", "pronoun", "preposition", "conjunction", "interjection"];

var randomPOS = partsOfSpeechArray[Math.floor(Math.random() * partsOfSpeechArray.length)];

var randomLength = Math.floor(Math.random() * (10-4)) + 4;

var letterValues = {
    "a": 1, "b": 3, "c": 3, "d": 2, "e": 1, "f": 4, "g": 2, "h": 4, "i": 1, "j": 8, "k": 5, "l": 1, "m": 3, "n": 1, "o": 1, "p": 3, "q": 10, "r": 1, "s": 1, "t": 1, "u": 1, "v": 4, "w": 4, "x": 8, "y": 4, "z": 10
}


$(document).ready(function() {

    var winningScore;
    var won;
    var answerArray = [];



///////////////////////////// BUTTON FUNCTIONALITY ////////////////////////////////

    $(".btn-link").on("click", function() { //fill in the blanks
        var letterGuessed = $(this).val(); 
        var index = answerArray.indexOf("_ "); //find first blank in array
        if (index !== -1) {
            answerArray[index] = letterGuessed; //...and replace with letter
        }
        answerArray.join(" ");
        $("#answerSpace").html(answerArray);
    });


    $("#clear").on("click", function() {
        function newBlanks() {
            var length = answerArray.length;
            $("#answerSpace").empty();
            for (var t=0; t<length; t++) {
                answerArray.splice(t, 1, "_ ");
            }
            $("#answerSpace").html(answerArray);
        }
        newBlanks();
    });


    $("#submit").on("click", function() {
        stop();
        checkIfWon();
        //console.log(answerArray)
    });


    $("#yes-lost").on("click", function() {
        location.reload();
    });


    $("#no-lost").on("click", function() {
        $("#thanksForPlaying").modal();
    });


    $("#yes-won").on("click", function() { // need to test this!!!!!!!!!!
        //////////go to next round
        won = true;
        startGame();
    });


    $("#no-won").on("click", function() {
        $("#thanksForPlaying").modal();
    });



//////////////////////////////////////// TIMER ////////////////////////////////////////////

    var secondsLeft = 15;
    var intervalId;

    function run() {
        clearInterval(intervalId);
        intervalId = setInterval(decrement, 1000);
    }

    function decrement() {
        secondsLeft--;
        $(".timer-container").text(secondsLeft);
        if (secondsLeft === 0) {
            stop();
            loss();
            //console.log(won); //ok
            return won;
        }
        return secondsLeft;
    }

    function stop() {
        clearInterval(intervalId);
    }


////////////////////////////////////////////////////////////////////////////////////

    function loss() {
        stop();
        $("#lossModal").modal(); //modal with option to restart game
        won = false;
        return won;
    };


    function win() {
        stop();
        $.ajax({
            method: "POST",
            url: "/api/scores",
            //data: //new leaderboard data
        }).then(function(results) {        
            console.log(results);
            $("#winModal").modal(); //modal with option to proceed to next round
            
            console.log(winningScore)
            console.log(won) //////////////won't work until get server hooked up

            return {
                winningScore: winningScore + secondsLeft * 10,
                won: true
            };
            
        });
    };


//////////////////////////////////// DETERMINE WIN OR LOSS ///////////////////////////////////////

    function checkIfWon() {

        //check to make sure all blanks were filled in
        if (answerArray.indexOf("_ ") > -1) {
            loss();
            return won;
        } else {
            var x = Object.keys(letterValues); //list of all letters
            console.log(x)
            //check to make sure the value of user's word matches the target score
            var scoreArray = [];
            //console.log(answerArray.length) //ok
            for (var a=0; a<answerArray.length; a++) { //for each letter in user's answer...
                if (x.indexOf(answerArray[a]) > -1) { //if letter appears in array...
                    var letterScore = letterValues[answerArray[a]];
                    scoreArray.push(letterScore);
                    console.log(answerArray[a])
                }
            }
            var sum = 0;
            for (var b=0; b<scoreArray.length; b++) { 
                sum += scoreArray[b]; //doesn't always grab all the letters!!!?????
                console.log(sum)
            };
            console.log("total sum: " + sum) //GRABS MULTIPLE TOTAL SUMS, BUT SHOULD ONLY GIVE ONE!!!!
            if (sum === targetScore) {
                console.log("matching target score");
//////////////////////////////////////////////////////////////////////////////////////////////////
                        //query db to make sure user's word is found in the dictionary
                        $.ajax({
                            method: GET,
                            url: "/api/all"
                        }).then (function(results) {

                        
                        "/api/all", function(results) { //////////////
                            console.log(results);
                            console.log(results[0].word);
                            if (results.indexOf(guessedWord) >= 0) { //if guessed word is found in dictionary...
                                console.log(results.indexOf(guessedWord));
                                var position = (results.indexOf(guessedWord)); //?????
                                console.log(position);
                                //if part of speech matches randomly generated one...
                                if (randomPOS == results.position.wordtype) { //not sure about this part
                                    win();
                                    console.log(won); /////
                                    return won;       
                                } else {
                                    loss();
                                    console.log(won); /////
                                    return won;                        
                                }
                            } else {
                                loss();
                                console.log(won); /////
                                return won;                    
                            }
                        }
                        })

                    } else {
                        loss();
                        console.log(won); //looping through to here multiple times (sum never = target score)
                        return won;
                    }
                           
                //} 
                //else { ////////////////////////////// 
                    //loss();
                    //console.log(won); //ok
                    //return won;
                //}
            //}
            var guessedWord = answerArray.join("");
            //console.log(guessedWord) //ok
        } 
                                    
                    return won;
                    console.log(won); /////
              
    }

/////////////////////////////////////////////////////////////////////////////////////////////////

    function startGame() {

        //randomLength(); //
        //randomPOS();
        $("#POS").text(randomPOS);
        //$("#length").text(randomPOS);
        //need to calculate target score!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! new instance of function????
        //targetScore(); //generate random score -- right range??         
        $("#score").text("Target score: " + targetScore);
        run();

        function generateBlanks() {
            answerArray = [];
            $("#answerSpace").empty();
            for (var t=0; t<randomLength; t++) {
                answerArray.push("_ ");
            }
            $("#answerSpace").html(answerArray);
            return answerArray;
            //console.log("answer array length is " + answerArray.length) //ok
        }
    
        //console.log(targetScore); //ok
        generateBlanks();

        console.log(won); //undefined
        //return targetScore, won;

    }


///////////////////////////////////// CALLING FUNCTIONS ////////////////////////////////////////////
    
    //on load...
    startGame(); //should I really be calling this on load, or just on new game????????????????

    console.log(won); // UNDEFINED -- need to get it recognize true or false at this level

    if (won === true) {
        winningScore += secondsLeft * 10; //carry over score to next round
        console.log("Nice work! You earned " + winningScore + " points.");
        //startGame(); //?????????????????????????????????
    }

    else if (won === false) {
        winningScore = 0;
        //startGame(); //????????????????????????????????
    }


});


/////////////////////////////////////////////////////////////////////////////////////////////

  // In this code below we create the Front-end JavaScript which "POSTS" our form data to our express server.
  // In essence, when the user hits submit, jQuery grabs all of the fields then sends a post request to our api
  // Our api recognizes the route (/api/tables)... and then runs the associated code (found in api-routes.js).
  // In this case the associated code "saves" the data to the table-data.js file or waitinglist-data.js file
  $("#submit-noun").on("click", function (event) {
    event.preventDefault();

    function getNouns() {
      $.get("/api/nouns", function (data) {
        for (var i = 0; i < data.length; i++) {
          if ($("#reserve-unique-id").val().trim() === data[i].word) {
            $("#definition-div").html(data[i].definition);
            console.log(data[i]);
          }
        }
      });
    }
    getNouns();
  });

  $("#submit-verb").on("click", function (event) {
    event.preventDefault();

    function getVerbs() {
      $.get("/api/verbs", function (data) {
        for (var i = 0; i < data.length; i++) {
          if ($("#reserve-unique-id").val().trim() === data[i].word) {
            $("#definition-div").html(data[i].definition);
            console.log(data[i]);
          }
        }
      });
    }
    getVerbs();
  });

  $("#submit-adj").on("click", function (event) {
    event.preventDefault();

    function getAdjectives() {
      $.get("/api/adjectives", function (data) {
        for (var i = 0; i < data.length; i++) {
          if ($("#reserve-unique-id").val().trim() === data[i].word) {
            $("#definition-div").html(data[i].definition);
            console.log(data[i]);
          }
        }
      });
    }
    getAdjectives();
  });

  $("#submit-adv").on("click", function (event) {
    event.preventDefault();

    function getAdverbs() {
      $.get("/api/adverbs", function (data) {
        for (var i = 0; i < data.length; i++) {
          if ($("#reserve-unique-id").val().trim() === data[i].word) {
            $("#definition-div").html(data[i].definition);
            console.log(data[i]);
          }
        }
      });
    }
    getAdverbs();
  });

  $(".btn-link").on("click", function (event) {
    event.preventDefault();
    console.log($(this).val());
  });

  $("#submit-main").on("click", function (event) {
    event.preventDefault();

    // Here we grab the form elements
    var newReservation = {
      customerName: $("#reserve-name").val().trim(),
      phoneNumber: $("#reserve-phone").val().trim(),
      customerID: $("#reserve-unique-id").val().trim()
    };

    console.log(newReservation);

    // This line is the magic. It"s very similar to the standard ajax function we used.
    // Essentially we give it a URL, we give it the object we want to send, then we have a "callback".
    // The callback is the response of the server. In our case, we set up code in api-routes that "returns" true or false
    // depending on if a tables is available or not.

    $.post("/api/scores", newReservation,
      function (data) {

        // If a table is available... tell user they are booked.
        if (data) {
          alert("Yay! You are officially booked!");
        }

        // If a table is available... tell user they on the waiting list.
        else {
          alert("Sorry you are on the wait list");
        }

        // Clear the form when submitting
        $("#reserve-name").val("");
        $("#reserve-phone").val("");
        $("#reserve-unique-id").val("");

      });

  });
</script>